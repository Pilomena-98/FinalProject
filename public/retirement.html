<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COCO · PPR Simulator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --primary:#2D3748;--secondary:#4A5568;--accent:#8E2DE2;--light-bg:#f0e7f1;--card-bg:#fff;
      --success:#38A169;--warning:#DD6B20;--danger:#E53E3E;--border:#E2E8F0;--text:#1A202C;--muted:#718096;
      --gradient:linear-gradient(135deg,#8E2DE2,#4A00E0)
    }
    *{box-sizing:border-box}body{margin:0;background:var(--light-bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{max-width:1200px;margin:24px auto;padding:16px}
    .header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .date{color:var(--muted)}
    .btn{display:inline-flex;gap:8px;align-items:center;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--gradient);color:#fff}
    .btn-primary:hover{opacity:.95;transform:translateY(-1px)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px}
    .card h3{margin:0 0 6px 0;color:var(--primary)}
    .muted{color:var(--muted)}
    .value{font-weight:800;font-size:26px;background:var(--gradient);-webkit-background-clip:text;background-clip:text;color:transparent}
    .section-title{font-size:22px;margin:6px 0 12px;color:var(--primary)}

    /* Form */
    .form{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    label{font-weight:600;color:var(--secondary);margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:15px}
    input:focus,select:focus{outline:none;border-color:#b78cf0;box-shadow:0 0 0 4px rgba(142,45,226,.08)}
    .inline{display:flex;gap:10px;align-items:center}
    .hint{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:6px 10px}
    tbody tr{background:#fff;border:1px solid var(--border)}
    tbody td{padding:10px}
    tbody tr{border-radius:10px}

    .pill{padding:4px 10px;border-radius:999px;background:#f2ecff;font-weight:700;font-size:12px;color:#5a2fd7}
    .flex{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .chart-wrap{height:360px}
    .divider{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <button class="btn btn-primary" onclick="window.location.href='main.html'"><i class="fa-solid fa-arrow-left"></i> Dashboard</button>
      <div class="date" id="today"></div>
    </div>

    <div class="card">
      <div class="flex">
        <h2 class="section-title">Retirement Planner (PPR) — Simulator</h2>
        <span class="pill">MX · deduction: 10% income o 5 UMA</span>
      </div>
      <p class="muted" style="margin:6px 0 16px">Adjust the parameters and estimate your retirement balance in nominal pesos and real pesos (adjusted for inflation), along with the estimated tax benefit and a sustainable monthly withdrawal (4% rule)</p>

      <form id="form" class="form">
        <div>
          <label>Current Age</label>
          <input id="age" type="number" min="18" max="64" value="35" />
        </div>
        <div>
          <label>Retirement Age</label>
          <input id="retAge" type="number" min="55" max="75" value="65" />
        </div>
        <div>
          <label>Annual Income (MXN)</label>
          <input id="salary" type="number" min="10000" step="1000" value="300000" />
          <div class="hint">Estimated gross annual</div>
        </div>
        <div>
          <label>Monthly contribution PPR (MXN)</label>
          <input id="monthly" type="number" min="100" step="100" value="2500" />
        </div>
        <div>
          <label>ISR marginal rate (%)</label>
          <input id="taxRate" type="number" min="0" max="45" step="0.5" value="20" />
          <div class="hint">To estimate tax savings</div>
        </div>
        <div>
          <label>Portfolio (nominal annual yieldl)</label>
          <select id="portfolio">
            <option value="0.04">Conservative (4%)</option>
            <option value="0.065" selected>Moderate (6.5%)</option>
            <option value="0.08">Aggressive (8%)</option>
          </select>
        </div>
        <div>
          <label>Annual Inflation (%)</label>
          <input id="inflation" type="number" min="0" max="15" step="0.1" value="4" />
        </div>
        <div>
          <label>Annual salary growth (%)</label>
          <input id="salaryGrowth" type="number" min="0" max="15" step="0.1" value="3" />
          <div class="inline" style="margin-top:6px">
            <input id="growContrib" type="checkbox" checked />
            <label for="growContrib" style="margin:0">Contribution grows with salary</label>
          </div>
        </div>
        <div>
          <label>Daily UMA (MXN)</label>
          <input id="umaDaily" type="number" min="50" step="0.01" value="115.37" />
          <div class="hint">Adjustable every year</div>
        </div>
        <div>
          <label>PPR current balance (MXN)</label>
          <input id="current" type="number" min="0" step="100" value="48500" />
        </div>
      </form>
      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" id="run"><i class="fa-solid fa-calculator"></i> Calculate</button>
        <button class="btn" id="export"><i class="fa-solid fa-file-arrow-down"></i> Export CSV</button>
      </div>
    </div>

    <div class="grid grid-3" style="margin-top:16px">
      <div class="card">
        <h3>Projected withdrawal balance (Nominal)</h3>
        <div class="value" id="projNominal">$0</div>
        <div class="muted">Before inflation</div>
      </div>
      <div class="card">
        <h3>Projected withdrawal balance (Real)</h3>
        <div class="value" id="projReal">$0</div>
        <div class="muted">Today's pesos</div>
      </div>
      <div class="card">
        <h3>Monthly income (4% rule)</h3>
        <div class="value" id="safeIncome">$0</div>
        <div class="muted">Today's pesos</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="flex">
        <h3 class="section-title">Estimated tax benefit</h3>
        <span class="pill" id="deductionCap">Limit: —</span>
      </div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div>
          <div class="muted">Annual deduction (year 1)</div>
          <div class="value" id="deductY1">$0</div>
        </div>
        <div>
          <div class="muted">Annual tax savings (year 1)</div>
          <div class="value" id="taxSaveY1">$0</div>
        </div>
        <div>
          <div class="muted">Tax savings upon retirement</div>
          <div class="value" id="taxSaveTotal">$0</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="chart-wrap">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="flex"><h3 class="section-title">Year-by-year projection</h3><span class="muted" id="yearsLabel"></span></div>
      <div class="divider"></div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Age</th>
              <th>Annual income</th>
              <th>Annual contribution</th>
              <th>Deduction used</th>
              <th>Tax savings</th>
              <th>Year-end balance (nominal)</th>
              <th>Year-end balance (real)</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=>n.toLocaleString('es-MX',{style:'currency',currency:'MXN',maximumFractionDigits:0});

    let chart;

    function today(){
      const opts={weekday:'long',year:'numeric',month:'long',day:'numeric'};
      $('today').textContent = new Date().toLocaleDateString('en-US',opts);
    }

    function realRate(nominal, inflation){
      return (1+nominal)/(1+inflation) - 1;
    }

    function run(){
      const age = +$('age').value; const retAge = +$('retAge').value;
      const years = Math.max(0, retAge - age);
      const salary0 = +$('salary').value;
      const monthly = +$('monthly').value;
      const annualContrib0 = monthly*12;
      const taxRate = (+$('taxRate').value)/100;
      const rNom = +$('portfolio').value;
      const infl = (+$('inflation').value)/100;
      const gSalary = (+$('salaryGrowth').value)/100;
      const growContrib = $('growContrib').checked;
      const umaDaily = +$('umaDaily').value;
      const umaYear = umaDaily*365;
      const current = +$('current').value;

      $('yearsLabel').textContent = years+" years";
      $('deductionCap').textContent = `Annual limit: ${fmt(Math.min(salary0*0.10, umaYear*5))}`;

      let salary = salary0;
      let annualContrib = annualContrib0;
      let accNom = current; // nominal
      let accReal = current; // real (se capitaliza a tasa real)
      const rReal = realRate(rNom, infl);

      const labels = ["Today"];
      const seriesNom = [accNom];
      const seriesReal = [accReal];
      const rows = [];
      let totalTaxSaved = 0;

      for(let y=1; y<=years; y++){
        // Topes y deducción
        const cap = Math.min(salary*0.10, umaYear*5, annualContrib);
        const taxSaved = cap * taxRate;
        totalTaxSaved += taxSaved;

        // Fin de año (nominal)
        accNom = (accNom + annualContrib) * (1 + rNom);
        // Fin de año (real, usando tasa real y montos en poder adquisitivo de hoy)
        accReal = (accReal + annualContrib/(1+infl)**y) * (1 + rReal); // aprox: aportación se descuenta a valor presente

        // guardar para tabla
        rows.push({
          year:y,
          age:age+y,
          salary,
          contrib:annualContrib,
          capUsed:cap,
          taxSaved,
          endNom:accNom,
          endReal:accReal
        });

        labels.push(`Year ${y}`);
        seriesNom.push(accNom);
        seriesReal.push(accReal);

        // crecer salario y aportación para el próximo año
        salary = salary * (1 + gSalary);
        if(growContrib){
          annualContrib = annualContrib * (1 + gSalary);
        }
      }

      // UI Cards
      $('projNominal').textContent = fmt(Math.round(accNom));
      $('projReal').textContent = fmt(Math.round(accReal));
      const safe = (accReal * 0.04)/12; // regla del 4%, en pesos reales
      $('safeIncome').textContent = fmt(Math.round(safe));

      // Beneficio fiscal
      if(rows.length){
        $('deductY1').textContent = fmt(Math.round(rows[0].capUsed));
        $('taxSaveY1').textContent = fmt(Math.round(rows[0].taxSaved));
      } else {
        $('deductY1').textContent = fmt(0);
        $('taxSaveY1').textContent = fmt(0);
      }
      $('taxSaveTotal').textContent = fmt(Math.round(totalTaxSaved));

      // Tabla
      const tbody = $('rows');
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.year}</td>
          <td>${r.age}</td>
          <td>${fmt(r.salary)}</td>
          <td>${fmt(r.contrib)}</td>
          <td>${fmt(r.capUsed)}</td>
          <td>${fmt(r.taxSaved)}</td>
          <td>${fmt(r.endNom)}</td>
          <td>${fmt(r.endReal)}</td>
        </tr>
      `).join('');

      // Chart
      const ctx = $('chart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'Nominal balance', data:seriesNom, tension:.2, borderWidth:3, fill:false},
            {label:'Real balance (Today´s pesos)', data:seriesReal, tension:.2, borderWidth:3, borderDash:[6,6], fill:false}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{mode:'index', intersect:false},
          plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`}}},
          scales:{y:{ticks:{callback:(v)=>fmt(v)}}, x:{ticks:{autoSkip:true,maxRotation:0}}}
        }
      });

      // Guardar último resultado para exportación
      window.__ppr_rows = rows;
    }

    function exportCSV(){
      const rows = window.__ppr_rows||[];
      if(!rows.length){ alert('First run the calculation'); return; }
      const header = ['Year','Age','Annual income','Annual contribution','Used deduction','Tax savings','Final balance (nominal)','Final balance (real)'];
      const csv = [header.join(',')]
        .concat(rows.map(r=>[
          r.year,
          r.age,
          Math.round(r.salary),
          Math.round(r.contrib),
          Math.round(r.capUsed),
          Math.round(r.taxSaved),
          Math.round(r.endNom),
          Math.round(r.endReal)
        ].join(',')))
        .join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'proyeccion_ppr.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // events
    $('run').addEventListener('click', run);
    $('export').addEventListener('click', exportCSV);
    today();
    run(); // primera corrida
  </script>
</body>
</html>
